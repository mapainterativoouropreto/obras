<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Obras Públicas</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- LAYOUT GERAL --- */
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Barra Lateral */
        #sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #map { flex-grow: 1; height: 100%; }

        /* --- ESTILOS DO MENU --- */
        h2 { color: #2c3e50; font-size: 1.2rem; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        
        details { margin-bottom: 8px; border: 1px solid #e9ecef; border-radius: 4px; background: white; }
        
        /* Estilo dos Sumários (Botões de abrir/fechar) */
        summary { cursor: pointer; padding: 10px; font-weight: 600; background-color: #e9ecef; list-style: none; position: relative; }
        summary:hover { background-color: #dee2e6; }
        summary::after { content: '+'; position: absolute; right: 10px; font-weight: bold; }
        details[open] > summary::after { content: '-'; }
        
        /* Indentações da Hierarquia */
        .nivel-tipo { margin: 5px 0 5px 10px; border-left: 3px solid #ced4da; }
        .nivel-status { margin: 5px 0 5px 10px; }
        
        /* Links das Obras */
        .obra-link {
            display: block;
            padding: 8px 10px 8px 25px; /* Recuo maior */
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }
        .obra-link:hover { background-color: #d1ecf1; color: #0c5460; font-weight: bold; padding-left: 30px; }

        /* Bolinha colorida do status */
        .status-dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 8px; }

        /* Botão Popup */
        .btn-streetview {
            display: inline-block; margin-top: 10px; padding: 5px 10px;
            background-color: #4285F4; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;
        }
        
        /* Texto vazio */
        .msg-vazio { padding: 10px; color: #999; font-style: italic; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Sumário de Obras</h2>
        <div id="menu-container">
            <p style="color: #666; font-size: 0.9em;">Carregando sistema...</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. CONFIGURAÇÃO DO MAPA ---
        var map = L.map('map', { center: [-15.79, -47.88], zoom: 5 });
        
        // Camadas
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' });
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' });
        
        satellite.addTo(map); // Inicia com Satélite
        L.control.layers({ "Mapa": osm, "Satélite": satellite }).addTo(map);

        var obrasLayer; 
        var obrasData = [];

        // --- 2. UTILITÁRIOS ---
        
        // Função para deixar primeira letra Maiúscula (ex: parada -> Parada)
        function capitalizar(texto) {
            if (!texto) return "";
            return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();
        }

        // Função de Cores (lê o texto original minúsculo)
        function definirCor(status) {
            var s = status ? status.toLowerCase() : '';
            if (s === 'concluida') return '#28a745';      // Verde
            if (s === 'andamento') return '#ffc107';      // Amarelo
            if (s === 'parada') return '#dc3545';         // Vermelho
            return '#333';
        }

        // --- 3. CARREGAMENTO E TRATAMENTO DE DADOS ---
        fetch('obras.geojson')
            .then(response => response.json())
            .then(data => {
                
                // --- TRUQUE PARA O TESTE: INVENTAR NOMES E CATEGORIAS ---
                // Aqui eu manipulo os dados na memória para ficarem bonitos no teste
                // sem você precisar editar o GeoJSON agora.
                let contador = 0;
                data.features.forEach(f => {
                    let s = f.properties.status.toLowerCase();
                    
                    // Força a categoria Infraestrutura para todos os testes
                    f.properties.categoria = "Infraestrutura";
                    
                    // Inventa nomes baseados no status
                    if (s.includes('parada')) {
                        f.properties.nome_obra = "Drenagem do Bairro Sul";
                        f.properties.tipo = "Obra de drenagem";
                    } else if (s.includes('andamento')) {
                        f.properties.nome_obra = "Pavimentação da Av. Central";
                        f.properties.tipo = "Obra de pavimentação";
                    } else if (s.includes('concluida')) {
                        f.properties.nome_obra = "Contenção da Encosta Verde";
                        f.properties.tipo = "Obra de contenção";
                    } else {
                        f.properties.nome_obra = "Obra Genérica " + (++contador);
                        f.properties.tipo = "Outros";
                    }
                });
                // -------------------------------------------------------

                obrasData = data.features;

                // Desenha no Mapa
                obrasLayer = L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 8, fillColor: definirCor(feature.properties.status),
                            color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                        });
                    },
                    onEachFeature: function (feature, layer) {
                        feature.properties.leafletId = L.stamp(layer);
                        var lat = feature.geometry.coordinates[1];
                        var lon = feature.geometry.coordinates[0];
                        
                        layer.bindPopup(`
                            <strong>${feature.properties.nome_obra}</strong><br>
                            Status: <span style="color:${definirCor(feature.properties.status)}">
                                <b>${capitalizar(feature.properties.status)}</b>
                            </span><br>
                            <a href="https://www.google.com/maps?q&layer=c&cbll=${lat},${lon}" target="_blank" class="btn-streetview">Ver no Street View</a>
                        `);
                    }
                }).addTo(map);

                map.fitBounds(obrasLayer.getBounds());
                construirMenu();
            });

        // --- 4. CONSTRUÇÃO DO MENU FIXO ---
        function construirMenu() {
            var container = document.getElementById('menu-container');
            container.innerHTML = '';

            // Definimos manualmente as categorias que queremos mostrar
            var categoriasDesejadas = ["Infraestrutura", "Edificações"];

            // Loop principal pelas categorias fixas
            categoriasDesejadas.forEach(function(catNome) {
                
                // Cria o elemento HTML da categoria
                var catDetails = document.createElement('details');
                // Se for Infraestrutura, já deixa aberto. Edificações fica fechado.
                catDetails.open = (catNome === "Infraestrutura"); 
                catDetails.innerHTML = `<summary>${catNome}</summary>`;

                // Filtra as obras que pertencem a essa categoria
                var obrasDaCategoria = obrasData.filter(f => f.properties.categoria === catNome);

                if (obrasDaCategoria.length === 0) {
                    // Se não tiver obras (caso de Edificações)
                    catDetails.innerHTML += `<div class="msg-vazio">Nenhuma obra cadastrada.</div>`;
                } else {
                    // Se tiver obras, agrupa por TIPO -> STATUS
                    var arvoreTipos = {};
                    
                    obrasDaCategoria.forEach(f => {
                        var tipo = f.properties.tipo || "Geral";
                        var status = f.properties.status || "Indefinido";
                        if (!arvoreTipos[tipo]) arvoreTipos[tipo] = {};
                        if (!arvoreTipos[tipo][status]) arvoreTipos[tipo][status] = [];
                        arvoreTipos[tipo][status].push(f);
                    });

                    // Gera o HTML dos Tipos
                    for (var tipo in arvoreTipos) {
                        var tipoDetails = document.createElement('details');
                        tipoDetails.className = 'nivel-tipo';
                        tipoDetails.innerHTML = `<summary>${tipo}</summary>`;
                        tipoDetails.open = false; // Tipos começam fechados para organização

                        // Gera o HTML dos Status dentro do Tipo
                        for (var status in arvoreTipos[tipo]) {
                            var statusDetails = document.createElement('details');
                            statusDetails.className = 'nivel-status';
                            var cor = definirCor(status);
                            // Aqui aplicamos a capitalização (andamento -> Andamento)
                            statusDetails.innerHTML = `<summary><span class="status-dot" style="background:${cor}"></span>${capitalizar(status)}</summary>`;
                            
                            // Lista as Obras finais
                            arvoreTipos[tipo][status].forEach(feat => {
                                var link = document.createElement('div');
                                link.className = 'obra-link';
                                link.innerText = feat.properties.nome_obra; // Usa o nome fictício que criamos
                                
                                link.onclick = function() {
                                    var layer = obrasLayer.getLayer(feat.properties.leafletId);
                                    if (layer) {
                                        map.flyTo(layer.getLatLng(), 17, { duration: 1.5 });
                                        layer.openPopup();
                                    }
                                };
                                statusDetails.appendChild(link);
                            });
                            tipoDetails.appendChild(statusDetails);
                        }
                        catDetails.appendChild(tipoDetails);
                    }
                }
                container.appendChild(catDetails);
            });
        }
    </script>
</body>
</html>
