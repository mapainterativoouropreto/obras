<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Obras em Tempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #sidebar { width: 300px; background: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; }
        #map { flex-grow: 1; height: 100%; }
        
        /* Estilos do Menu */
        h2 { color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        details { margin-bottom: 8px; border: 1px solid #e9ecef; background: white; border-radius: 4px; }
        summary { cursor: pointer; padding: 10px; background: #e9ecef; font-weight: 600; list-style: none; }
        summary:hover { background: #dee2e6; }
        
        .nivel-tipo { margin: 5px 0 5px 15px; border-left: 3px solid #ccc; }
        .nivel-status { margin: 5px 0 5px 10px; }
        .obra-link { display: block; padding: 8px 10px 8px 20px; text-decoration: none; color: #333; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.9em; }
        .obra-link:hover { background: #d1ecf1; color: #0056b3; font-weight: bold; }
        .status-dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 8px; }
        .btn-streetview { display: inline-block; margin-top: 10px; padding: 5px 10px; background: #4285F4; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Sumário de Obras</h2>
        <div id="menu-container">Carregando dados da planilha...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // 1. MAPA
        var map = L.map('map').setView([-15.79, -47.88], 5);
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' });
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' });
        
        satellite.addTo(map);
        L.control.layers({ "Mapa": osm, "Satélite": satellite }).addTo(map);
        
        var obrasLayer = L.layerGroup().addTo(map);
        var obrasData = [];

        // ---------------------------------------------------------
        // 2. LINK DA PLANILHA (O ÚNICO LUGAR QUE VOCÊ MEXE)
        // ---------------------------------------------------------
        
        var googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5nSI1Y60cpNnx3_52KlzwKqYk4cueLFn_I-Yoi61qpMoQhcKz5BTJgE42bvOA2wOcv0Zw7bM_Syuf/pub?output=csv'; 

        // ---------------------------------------------------------

        function definirCor(status) {
            var s = status ? status.toLowerCase().trim() : '';
            if (s.includes('concluida') || s.includes('concluída')) return '#28a745'; // Verde
            if (s.includes('andamento')) return '#ffc107'; // Amarelo
            if (s.includes('parada')) return '#dc3545'; // Vermelho
            return '#333';
        }

        function capitalizar(texto) {
            return texto ? texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase() : "";
        }

        // 3. LER A PLANILHA E CRIAR OS PONTOS
        Papa.parse(googleSheetUrl, {
            download: true,
            header: true,
            complete: function(results) {
                obrasData = [];
                results.data.forEach(linha => {
                    if(linha.Latitude && linha.Longitude) {
                        var lat = parseFloat(linha.Latitude.replace(',', '.'));
                        var lon = parseFloat(linha.Longitude.replace(',', '.'));
                        
                        if(!isNaN(lat) && !isNaN(lon)) {
                            obrasData.push({
                                type: "Feature",
                                properties: {
                                    nome_obra: linha.Nome,
                                    status: linha.Status,
                                    categoria: linha.Categoria || "Infraestrutura",
                                    tipo: linha.Tipo || "Geral",
                                    leafletId: null 
                                },
                                geometry: { coordinates: [lon, lat] }
                            });
                        }
                    }
                });
                renderizarMapa();
                construirMenu();
            },
            error: function() {
                document.getElementById('menu-container').innerHTML = "Erro ao ler link da planilha.";
            }
        });

        function renderizarMapa() {
            var geojson = L.geoJSON(obrasData, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8, fillColor: definirCor(feature.properties.status),
                        color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                    });
                },
                onEachFeature: function (feature, layer) {
                    feature.properties.leafletId = L.stamp(layer);
                    var lat = feature.geometry.coordinates[1];
                    var lon = feature.geometry.coordinates[0];
                    layer.bindPopup(`
                        <strong>${feature.properties.nome_obra}</strong><br>
                        Status: <b style="color:${definirCor(feature.properties.status)}">${capitalizar(feature.properties.status)}</b><br>
                        <a href="https://www.google.com/maps?q&layer=c&cbll=${lat},${lon}" target="_blank" class="btn-streetview">Street View</a>
                    `);
                }
            });
            obrasLayer.addLayer(geojson);
            if (obrasData.length > 0) map.fitBounds(geojson.getBounds());
        }

        function construirMenu() {
            var container = document.getElementById('menu-container');
            container.innerHTML = '';
            
            // Define as Categorias Fixas
            ["Infraestrutura", "Edificações"].forEach(catNome => {
                var catDetails = document.createElement('details');
                catDetails.open = (catNome === "Infraestrutura");
                catDetails.innerHTML = `<summary>${catNome}</summary>`;
                
                var obrasDaCategoria = obrasData.filter(f => f.properties.categoria === catNome);
                
                if(obrasDaCategoria.length === 0) {
                    catDetails.innerHTML += `<div style="padding:10px; color:#999; font-style:italic">Nenhuma obra.</div>`;
                } else {
                    // Agrupa por Tipo e depois Status
                    var grupos = {};
                    obrasDaCategoria.forEach(f => {
                        var tipo = f.properties.tipo;
                        var status = f.properties.status;
                        if(!grupos[tipo]) grupos[tipo] = {};
                        if(!grupos[tipo][status]) grupos[tipo][status] = [];
                        grupos[tipo][status].push(f);
                    });

                    for(var tipo in grupos) {
                        var tipoDetails = document.createElement('details');
                        tipoDetails.className = 'nivel-tipo';
                        tipoDetails.innerHTML = `<summary>${tipo}</summary>`;
                        
                        for(var status in grupos[tipo]) {
                            var statusDetails = document.createElement('details');
                            statusDetails.className = 'nivel-status';
                            var cor = definirCor(status);
                            statusDetails.innerHTML = `<summary><span class="status-dot" style="background:${cor}"></span>${capitalizar(status)}</summary>`;
                            
                            grupos[tipo][status].forEach(feat => {
                                var link = document.createElement('div');
                                link.className = 'obra-link';
                                link.innerText = feat.properties.nome_obra;
                                link.onclick = function() {
                                    obrasLayer.eachLayer(layerGroup => {
                                        var layer = layerGroup.getLayer(feat.properties.leafletId);
                                        if(layer) { map.flyTo(layer.getLatLng(), 17); layer.openPopup(); }
                                    });
                                };
                                statusDetails.appendChild(link);
                            });
                            tipoDetails.appendChild(statusDetails);
                        }
                        catDetails.appendChild(tipoDetails);
                    }
                }
                container.appendChild(catDetails);
            });
        }
    </script>
</body>
</html>