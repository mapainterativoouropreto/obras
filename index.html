<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Obras em Tempo Real</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- LAYOUT GERAL --- */
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Barra Lateral */
        #sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #map { flex-grow: 1; height: 100%; }

        /* --- ESTILOS DO MENU --- */
        h2 { color: #2c3e50; font-size: 1.2rem; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        details { margin-bottom: 8px; border: 1px solid #e9ecef; border-radius: 4px; background: white; }
        summary { cursor: pointer; padding: 10px; font-weight: 600; background-color: #e9ecef; list-style: none; position: relative; }
        summary:hover { background-color: #dee2e6; }
        summary::after { content: '+'; position: absolute; right: 10px; font-weight: bold; }
        details[open] > summary::after { content: '-'; }
        
        .nivel-tipo { margin: 5px 0 5px 10px; border-left: 3px solid #ced4da; }
        .nivel-status { margin: 5px 0 5px 10px; }
        
        .obra-link {
            display: block; padding: 8px 10px 8px 25px; text-decoration: none; color: #333;
            border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; background: #fff;
        }
        .obra-link:hover { background-color: #d1ecf1; color: #0c5460; font-weight: bold; padding-left: 30px; }
        .status-dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 8px; }
        .btn-streetview {
            display: inline-block; margin-top: 10px; padding: 5px 10px;
            background-color: #4285F4; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;
        }
        .msg-vazio { padding: 10px; color: #999; font-style: italic; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Sumário de Obras</h2>
        <div id="menu-container">
            <p style="color: #666; font-size: 0.9em;">Conectando à planilha...</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // --- 1. CONFIGURAÇÃO DO MAPA ---
        var map = L.map('map', { center: [-15.79, -47.88], zoom: 5 });
        
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' });
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' });
        
        satellite.addTo(map);
        L.control.layers({ "Mapa": osm, "Satélite": satellite }).addTo(map);

        var obrasLayer = L.layerGroup().addTo(map); // Grupo vazio para adicionar pontos depois
        var obrasData = []; // Vai guardar os dados da planilha

        // --- 2. CONFIGURAÇÃO DA PLANILHA (Google Sheets) ---
        // COLE O SEU LINK CSV AQUI DENTRO DAS ASPAS:
        var googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5nSI1Y60cpNnx3_52KlzwKqYk4cueLFn_I-Yoi61qpMoQhcKz5BTJgE42bvOA2wOcv0Zw7bM_Syuf/pub?output=csv';

        // --- 3. FUNÇÕES UTILITÁRIAS ---
        function capitalizar(texto) {
            if (!texto) return "";
            return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();
        }

        function definirCor(status) {
            var s = status ? status.toLowerCase().trim() : ''; // trim remove espaços acidentais
            if (s === 'concluida' || s === 'concluída') return '#28a745';
            if (s === 'andamento' || s === 'em andamento') return '#ffc107';
            if (s === 'parada') return '#dc3545';
            return '#333';
        }

        // --- 4. CARREGAR DADOS DA PLANILHA ---
        // Usamos PapaParse para ler o CSV direto do Google
        Papa.parse(googleSheetUrl, {
            download: true,
            header: true, // Usa a primeira linha como cabeçalho (Nome, Status, etc)
            complete: function(results) {
                var dadosBrutos = results.data;
                
                // Limpa o array global
                obrasData = []; 

                // Processa cada linha da planilha
                dadosBrutos.forEach(linha => {
                    // Verifica se a linha tem latitude e longitude preenchidas
                    if(linha.Latitude && linha.Longitude) {
                        
                        // Transforma a linha da planilha em um formato que nosso código já entende (Feature)
                        var latitude = parseFloat(linha.Latitude.replace(',', '.')); // Garante que lê 10,5 como 10.5
                        var longitude = parseFloat(linha.Longitude.replace(',', '.'));

                        if (!isNaN(latitude) && !isNaN(longitude)) {
                            var feature = {
                                type: "Feature",
                                properties: {
                                    nome_obra: linha.Nome || "Sem nome",
                                    status: linha.Status || "Indefinido",
                                    categoria: linha.Categoria || "Infraestrutura",
                                    tipo: linha.Tipo || "Outros"
                                },
                                geometry: {
                                    coordinates: [longitude, latitude] // Leaflet usa [Lon, Lat]
                                }
                            };
                            obrasData.push(feature);
                        }
                    }
                });

                desenharNoMapa();
                construirMenu();
            },
            error: function(err) {
                console.error("Erro ao ler planilha:", err);
                document.getElementById('menu-container').innerHTML = "<p style='color:red'>Erro ao ler planilha. Verifique o link.</p>";
            }
        });

        // --- 5. DESENHAR NO MAPA ---
        function desenharNoMapa() {
            var geojsonLayer = L.geoJSON(obrasData, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8, fillColor: definirCor(feature.properties.status),
                        color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                    });
                },
                onEachFeature: function (feature, layer) {
                    // Salva ID para o menu clicar
                    feature.properties.leafletId = L.stamp(layer);
                    
                    var lat = feature.geometry.coordinates[1];
                    var lon = feature.geometry.coordinates[0];
                    
                    layer.bindPopup(`
                        <strong>${feature.properties.nome_obra}</strong><br>
                        Status: <span style="color:${definirCor(feature.properties.status)}">
                            <b>${capitalizar(feature.properties.status)}</b>
                        </span><br>
                        <a href="https://www.google.com/maps?q&layer=c&cbll=${lat},${lon}" target="_blank" class="btn-streetview">Ver no Street View</a>
                    `);
                }
            });
            
            obrasLayer.addLayer(geojsonLayer);
            
            if (obrasData.length > 0) {
                map.fitBounds(geojsonLayer.getBounds());
            }
        }

        // --- 6. MENU LATERAL (Igual ao anterior) ---
        function construirMenu() {
            var container = document.getElementById('menu-container');
            container.innerHTML = '';

            var categoriasDesejadas = ["Infraestrutura", "Edificações"];

            categoriasDesejadas.forEach(function(catNome) {
                var catDetails = document.createElement('details');
                catDetails.open = (catNome === "Infraestrutura"); 
                catDetails.innerHTML = `<summary>${catNome}</summary>`;

                // Filtra usando os dados da planilha
                var obrasDaCategoria = obrasData.filter(f => f.properties.categoria === catNome);

                if (obrasDaCategoria.length === 0) {
                    catDetails.innerHTML += `<div class="msg-vazio">Nenhuma obra cadastrada.</div>`;
                } else {
                    var arvoreTipos = {};
                    obrasDaCategoria.forEach(f => {
                        var tipo = f.properties.tipo || "Geral";
                        var status = f.properties.status || "Indefinido";
                        if (!arvoreTipos[tipo]) arvoreTipos[tipo] = {};
                        if (!arvoreTipos[tipo][status]) arvoreTipos[tipo][status] = [];
                        arvoreTipos[tipo][status].push(f);
                    });

                    for (var tipo in arvoreTipos) {
                        var tipoDetails = document.createElement('details');
                        tipoDetails.className = 'nivel-tipo';
                        tipoDetails.innerHTML = `<summary>${tipo}</summary>`;
                        
                        for (var status in arvoreTipos[tipo]) {
                            var statusDetails = document.createElement('details');
                            statusDetails.className = 'nivel-status';
                            var cor = definirCor(status);
                            statusDetails.innerHTML = `<summary><span class="status-dot" style="background:${cor}"></span>${capitalizar(status)}</summary>`;
                            
                            arvoreTipos[tipo][status].forEach(feat => {
                                var link = document.createElement('div');
                                link.className = 'obra-link';
                                link.innerText = feat.properties.nome_obra; 
                                
                                link.onclick = function() {
                                    // Procura o layer dentro do grupo
                                    obrasLayer.eachLayer(function(layerGroup) {
                                        var layer = layerGroup.getLayer(feat.properties.leafletId);
                                        if (layer) {
                                            map.flyTo(layer.getLatLng(), 17, { duration: 1.5 });
                                            layer.openPopup();
                                        }
                                    });
                                };
                                statusDetails.appendChild(link);
                            });
                            tipoDetails.appendChild(statusDetails);
                        }
                        catDetails.appendChild(tipoDetails);
                    }
                }
                container.appendChild(catDetails);
            });
        }
    </script>
</body>
</html>