<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Obras Públicas</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- LAYOUT GERAL --- */
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Barra Lateral (Menu) */
        #sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto; /* Barra de rolagem se a lista for grande */
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* Mapa */
        #map { flex-grow: 1; height: 100%; }

        /* --- ESTILOS DO MENU (ACORDEÃO) --- */
        h2 { color: #2c3e50; font-size: 1.2rem; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        
        /* Detalhes (Categorias/Tipos) */
        details { margin-bottom: 5px; border: 1px solid #eee; border-radius: 4px; background: white; }
        summary { cursor: pointer; padding: 10px; font-weight: bold; background-color: #e9ecef; list-style: none; }
        summary:hover { background-color: #dee2e6; }
        summary::after { content: '+'; float: right; font-weight: bold; }
        details[open] summary::after { content: '-'; }
        
        /* Níveis hierárquicos (Indentação) */
        .nivel-tipo { margin-left: 10px; border-left: 2px solid #ccc; }
        .nivel-status { margin-left: 10px; }
        
        /* O Link da Obra final */
        .obra-link {
            display: block;
            padding: 8px 10px;
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .obra-link:hover { background-color: #d1ecf1; color: #0c5460; font-weight: bold; }

        /* Legenda de cores no texto */
        .status-dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }

        /* Botão do Street View no Popup */
        .btn-streetview {
            display: inline-block; margin-top: 10px; padding: 5px 10px;
            background-color: #4285F4; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Sumário de Obras</h2>
        <div id="menu-container">
            <p style="color: #666; font-size: 0.9em;">Carregando obras...</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURAÇÃO DO MAPA ---
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' });
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' });

        var map = L.map('map', {
            center: [-15.79, -47.88],
            zoom: 5,
            layers: [satellite] // Começa com satélite
        });

        L.control.layers({ "Mapa": osm, "Satélite": satellite }).addTo(map);

        // --- VARIÁVEIS GLOBAIS ---
        var obrasLayer; // Vai guardar nossos pontos para usarmos no zoom
        var obrasData = []; // Vai guardar os dados brutos

        // --- FUNÇÃO DE CORES ---
        function definirCor(status) {
            var s = status ? status.toLowerCase() : '';
            if (s === 'concluida') return '#28a745';
            if (s === 'andamento') return '#ffc107';
            if (s === 'parada') return '#dc3545';
            if (s === 'manutencao') return '#17a2b8';
            return '#333';
        }

        // --- CARREGAMENTO DOS DADOS ---
        fetch('obras.geojson')
            .then(response => response.json())
            .then(data => {
                obrasData = data.features; // Salva os dados na memória

                // 1. Adiciona ao Mapa
                obrasLayer = L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 8, fillColor: definirCor(feature.properties.status),
                            color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                        });
                    },
                    onEachFeature: function (feature, layer) {
                        // Salva o ID do Leaflet na feature para usarmos no zoom depois
                        feature.properties.leafletId = L.stamp(layer); 
                        
                        var lat = feature.geometry.coordinates[1];
                        var lon = feature.geometry.coordinates[0];
                        var linkStreetView = `https://www.google.com/maps?q&layer=c&cbll=${lat},${lon}`;
                        
                        layer.bindPopup(`
                            <strong>${feature.properties.nome_obra}</strong><br>
                            Status: ${feature.properties.status}<br>
                            <a href="${linkStreetView}" target="_blank" class="btn-streetview">Street View</a>
                        `);
                    }
                }).addTo(map);

                map.fitBounds(obrasLayer.getBounds());

                // 2. Constrói o Menu Lateral
                construirMenu();
            })
            .catch(err => console.error("Erro:", err));


        // --- LÓGICA DO MENU HIERÁRQUICO ---
        function construirMenu() {
            var container = document.getElementById('menu-container');
            container.innerHTML = ''; // Limpa "Carregando..."

            // Vamos organizar os dados em árvore: Categoria -> Tipo -> Status -> Lista de Obras
            var arvore = {};

            obrasData.forEach(function(feature) {
                var props = feature.properties;
                // Se não tiver coluna categoria no QGIS, usa "Geral"
                var cat = props.categoria || "Infraestrutura"; 
                // Se não tiver tipo, usa "Diversos"
                var tipo = props.tipo || "Outros";
                var status = props.status || "Indefinido";

                if (!arvore[cat]) arvore[cat] = {};
                if (!arvore[cat][tipo]) arvore[cat][tipo] = {};
                if (!arvore[cat][tipo][status]) arvore[cat][tipo][status] = [];

                arvore[cat][tipo][status].push(feature);
            });

            // Agora vamos gerar o HTML dessa árvore
            for (var cat in arvore) {
                // Nível 1: Categoria (Ex: Infraestrutura)
                var catDetails = document.createElement('details');
                catDetails.open = true; // Já vem aberto por padrão
                catDetails.innerHTML = `<summary>${cat}</summary>`;
                
                for (var tipo in arvore[cat]) {
                    // Nível 2: Tipo (Ex: Drenagem)
                    var tipoDetails = document.createElement('details');
                    tipoDetails.className = 'nivel-tipo';
                    tipoDetails.innerHTML = `<summary>${tipo}</summary>`;
                    
                    for (var status in arvore[cat][tipo]) {
                        // Nível 3: Status (Ex: Parada)
                        var statusDetails = document.createElement('details');
                        statusDetails.className = 'nivel-status';
                        var cor = definirCor(status);
                        statusDetails.innerHTML = `<summary><span class="status-dot" style="background:${cor}"></span>${status}</summary>`;
                        
                        // Nível 4: As Obras (Links)
                        arvore[cat][tipo][status].forEach(function(feat) {
                            var link = document.createElement('div');
                            link.className = 'obra-link';
                            link.innerText = feat.properties.nome_obra || "Obra sem nome";
                            
                            // AÇÃO DO CLIQUE:
                            link.onclick = function() {
                                // 1. Acha o layer no mapa pelo ID que salvamos
                                var layer = obrasLayer.getLayer(feat.properties.leafletId);
                                if (layer) {
                                    // 2. Voa até o local
                                    map.flyTo(layer.getLatLng(), 17, { duration: 1.5 });
                                    // 3. Abre o popup
                                    layer.openPopup();
                                }
                            };
                            statusDetails.appendChild(link);
                        });
                        tipoDetails.appendChild(statusDetails);
                    }
                    catDetails.appendChild(tipoDetails);
                }
                container.appendChild(catDetails);
            }
        }
    </script>
</body>
</html>